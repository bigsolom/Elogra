<script type="text/javascript">
    $(document).ready(function(){
        
        $(window).scroll(function(){
            if  ($(window).scrollTop() == $(document).height() - $(window).height()){//only when scrolling down
                       getMore(); 
            }
        });
                
        function getMore(){
            $.ajax({
                url: "<?= $this->url(array('controller' => 'hakawy', 'action' => 'more'), 'default', true) ?>",
                dataType: "json", 
                data: getPaginationData(),
                beforeSend:function(){ // Are not working with dataType:'jsonp'
                    $('.paginated').after("<div align='center'><img  id='loading' src='/img/progressbar.gif' /></div>");
                },
                complete: function(){
                    $('#loading').remove();
                },
                success: function(data) {
                    $(".paginated").append(data.html);
                    var page = $(".paginated").attr('data-page');
                    page++;
                    $(".paginated").attr('data-page',page);
                }
             });
        }
         
         function getPaginationData(){
            var page = $(".paginated").attr('data-page');
            page++;
            return {page: page};
         }
         
         
        
        
    });
           
        function addHekaya(){
           $.ajax({
                url: "<?= $this->url(array('controller' => 'hakawy', 'action' => 'submit'), 'default', true) ?>",
                dataType: "json", 
                data: $('#hekayaForm').serialize(),
                beforeSend:function(){ //disable button and field
                   $('#taxiTalksInput').attr("disabled","disabled");
                   $('#hekayaButton').attr("disabled","disabled");
                },
                complete: function(){//enable them back
                    $('#taxiTalksInput').attr("value","");
                    $('#taxiTalksInput').removeAttr("disabled");
                    $('#hekayaButton').removeAttr("disabled");
                },
                success: function(data) {
                    $(".container").prepend(data.html);
                }
             });
        }

</script>

<form id="hekayaForm" method="post" onsubmit="addHekaya(); return false;" class="well">
    <fieldset>
<textarea class="expand" 
id="taxiTalksInput" name="taxiTalksInput" maxlength="500"  onfocus="OnFocusInput(this)" onblur="OnBlurInput(this)" placeholder="قول للناس حدوتك"></textarea>
    <input type="submit" name="button" id="hekayaButton" value="<?=  Application_Service_Translate::_('share')?>" class="btn btn-large" />
	 </fieldset>
</form>
<script type="text/javascript" src="/js/charcount.js"></script>

<!-- YAMLI CODE START -->
<script type="text/javascript" src="http://api.yamli.com/js/yamli_api.js"></script>

		<script type="text/javascript">
  if (typeof(Yamli) == "object" && Yamli.init( { uiLanguage: "ar" , startMode: "offOrUserDefault" } ))
  {
    Yamli.yamlify( "taxiTalksInput", { settingsPlacement: "inside" } );
  }
</script>

<div class="container paginated" data-page="1">
    <?php
    foreach ($this->hakawy as $hekaya) {
        ?>
            <?= $this->partial('partials/_hekaya.phtml', array('hekaya' => $hekaya)); ?>
            
        <?php
    }
    ?>
       
</div>
